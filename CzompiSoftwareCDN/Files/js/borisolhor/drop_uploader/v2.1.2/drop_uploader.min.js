!function(A){jQuery.fn.drop_uploader=function(E){E=A.extend({uploader_text:"Drop files to upload, or",browse_text:"Browse",only_one_error_text:"Only one file allowed",not_allowed_error_text:"File type is not allowed",big_file_before_error_text:"Files, bigger than",big_file_after_error_text:"is not allowed",allowed_before_error_text:"Only",allowed_after_error_text:"files allowed",browse_css_class:"button button-primary",browse_css_selector:"file_browse",uploader_icon:'<i class="pe-7s-cloud-upload"></i>',file_icon:'<i class="pe-7s-file"></i>',progress_color:"#4a90e2",time_show_errors:5,layout:"thumbnails",method:"normal",chunk_size:1e6,concurrent_uploads:5,show_percentage:!0,existing_files:!1,existing_files_removable:!0,send_existing_files:!1,url:"ajax_upload.php",delete_url:"ajax_delete.php"},E),this.each(function(e,t){var d=t,o=A(d).attr("accept"),_=A(d).prop("multiple"),p=parseInt(A(d).data("count")),h=A(d).prop("name"),u=0,v="drop_uploader_"+e,m=0,a=0,g=0,i=A(d).parent("form"),l=A(i).find("input[name=MAX_FILE_SIZE]").val();void 0!==l&&(u=parseInt(l));var n=A(d).data("maxfilesize");void 0!==n&&(u=parseInt(n));var b=E.layout;"thumbnails"==A(d).data("layout")?b="thumbnails":"list"==A(d).data("layout")&&(b="list");var c=E.method;"normal"==A(d).data("method")?c="normal":"ajax"==A(d).data("method")?c="ajax":"chunked"==A(d).data("method")&&(c="chunked");var w=E.url;""!=A(d).data("url")&&void 0!==A(d).data("url")&&(w=A(d).data("url"));var x=E.delete_url;""!=A(d).data("deleteurl")&&void 0!==A(d).data("deleteurl")&&(x=A(d).data("deleteurl"));var s=E.existing_files;""!=A(d).data("existing_files")&&void 0!==A(d).data("existing_files")&&(s=A(d).data("existing_files"));var r=E.existing_files_removable;""!=A(d).data("existing_files_removable")&&void 0!==A(d).data("existing_files_removable")&&(r=A(d).data("existing_files_removable"));var f=E.send_existing_files;""!=A(d).data("send_existing_files")&&void 0!==A(d).data("send_existing_files")&&(f=A(d).data("send_existing_files")),A(d).attr("id",T()),A(d).wrap('<div id="'+v+'" class="drop_uploader drop_zone"></div>'),A(d).before('<div class="text_wrapper">'+E.uploader_icon+' <span class="text">'+E.uploader_text+' <a href="#" class="'+E.browse_css_class+" "+E.browse_css_selector+'">'+E.browse_text+"</a></span></div>"),A(d).before('<span class="errors"></span>'),"ajax"!=c&&"chunked"!=c||A(d).attr("name","");var y="files";if("thumbnails"==b&&(y+=" thumb"),"ajax"==c&&(y+=" ajax"),"chunked"==c&&(y+=" ajax"),A(d).before('<ul class="'+y+'"></ul>'),Array.isArray(s)&&"normal"!=c&&0<s.length){m=s.length;for(var k,M=0;M<s.length;M++){s[M],"thumbnails"==b?(A("#"+v+" .files.thumb").append('<li id="selected_file_'+a+'"><div class="thumbnail"></div><span class="title" title="'+s[M].name+'"> '+s[M].name+" </span></li>"),thumbnail=void 0!==s[M].thumbnail?s[M].thumbnail:"",type=void 0!==s[M].type?s[M].type:"",function(e,t,a){""!=e?A("#"+v+" #selected_file_"+a+" div.thumbnail").attr("style",'background-image: url("'+e+'")'):""!=t&&("video"==t?A("#"+v+" #selected_file_"+a+" div.thumbnail").html('<i class="pe-7s-video"></i>'):"audio"==t?A("#"+v+" #selected_file_"+a+" div.thumbnail").html('<i class="pe-7s-volume"></i>'):A("#"+v+" #selected_file_"+a+" div.thumbnail").html('<i class="pe-7s-file"></i>'));A("#"+v+" #selected_file_"+a+" div.thumbnail").append('<div class="du_hover_layer"></div>')}(thumbnail,type,a)):A("#"+v+" .files").append('<li id="selected_file_'+a+'">'+E.file_icon+" <span>"+s[M].name+"</span> </li>"),f&&A("#"+v).append('<input id="hidden_file_'+a+'" type="hidden" name="'+h+'" value="'+s[M].id+'" >'),r&&(k=A('<i class="pe-7s-trash action-delete" data-fileid="'+s[M].id+'"></i>').hide(),"thumbnails"==b?A("#"+v+" #selected_file_"+a+" div.thumbnail").append(k):"list"==b&&A("#"+v+" #selected_file_"+a).append(k),k.delay(500).fadeIn("slow"),A("#"+v+" #selected_file_"+a+" i.action-delete").on("click",function(e){var t,a=A(this).data("fileid");"thumbnails"==b?t=A(this).parent().parent().attr("id").substring(14,999):"list"==b&&(t=A(this).parent().attr("id").substring(14,999)),A.ajax({url:x,data:"fileid="+a}).done(function(){A("#"+v+" #selected_file_"+t).delay(500).fadeOut("slow"),A("#"+v+" #hidden_file_"+t).remove(),m--})})),a++}}var j=A("#"+v);function I(e){void 0===e&&(e=A(d)[0].files),"normal"==c&&A("#"+v+" .files").html("");for(var t=0;t<e.length;t++)"thumbnails"==b?(A("#"+v+" .files.thumb").append('<li id="selected_file_'+a+'"><div class="thumbnail"></div><span class="title" title="'+e[t].name+'"> '+e[t].name+" </span></li>"),function(l,n){var t=new FileReader;(function(e,r){var t=new FileReader;t.onload=function(e){var t=new DataView(e.target.result);if(65496!=t.getUint16(0,!1))return r(-2);for(var a=t.byteLength,i=2;i<a;){var l=t.getUint16(i,!1);if(i+=2,65505==l){if(1165519206!=t.getUint32(i+=2,!1))return r(-1);var n=18761==t.getUint16(i+=6,!1);i+=t.getUint32(i+4,n);var d=t.getUint16(i,n);i+=2;for(var s=0;s<d;s++)if(274==t.getUint16(i+12*s,n))return r(t.getUint16(i+12*s+8,n))}else{if(65280!=(65280&l))break;i+=t.getUint16(i,!1)}}return r(-1)},t.readAsArrayBuffer(e)})(l,function(e){var t="";8==e?t="rotate_90":3==e?t="rotate_180":6==e&&(t="rotate_270"),A("#"+v+" #selected_file_"+n+" div.thumbnail").addClass(t)}),l.type.match("image/*")&&t.readAsDataURL(l);t.onloadend=function(e){var i=new Image;i.src=t.result,i.onload=function(){var e=document.createElement("canvas");e.getContext("2d").drawImage(i,0,0);var t=i.width,a=i.height;a<t?200<t&&(a*=200/t,t=200):200<a&&(t*=200/a,a=200),e.width=t,e.height=a,e.getContext("2d").drawImage(i,0,0,t,a),dataurl=e.toDataURL(l.type),A("#"+v+" #selected_file_"+n+" div.thumbnail").attr("style",'background-image: url("'+dataurl+'")'),A("#"+v+" #selected_file_"+n+" div.thumbnail").append('<div class="du_hover_layer"></div>')}}}(e[t],a)):A("#"+v+" .files").append('<li id="selected_file_'+a+'">'+E.file_icon+" <span>"+e[t].name+"</span> </li>"),"ajax"==c?L(e[t],a):"chunked"==c&&O(e[t],a),a++,"ajax"!=c&&"chunked"!=c||m++}function L(i,l){var e,n,d,t;g>=E.concurrent_uploads?setTimeout(L,5e3,i,l):(g++,A("#"+v).trigger("file_upload_start",[i.name]),e=new XMLHttpRequest,"thumbnails"==b?(A("#"+v+" #selected_file_"+l+" div.thumbnail").after('<div class="du_progress"></div>'),E.show_percentage&&A("#"+v+" #selected_file_"+l+" div.thumbnail").append('<div class="percent"></div>')):(A("#"+v+" #selected_file_"+l).append('<div class="du_progress"></div>'),E.show_percentage&&A("#"+v+" #selected_file_"+l).append('<div class="percent"></div>')),n=A("#"+v+" #selected_file_"+l+" .du_progress"),d=A("#"+v+" #selected_file_"+l+" .percent"),(e.upload||e).addEventListener("progress",function(e){var t=e.position||e.loaded,a=e.totalSize||e.total,i=Math.round(t/a*100);d.html(Math.round(i)+"%"),U(n[0],i/100,b)}),e.addEventListener("load",function(e){var t,a=JSON.parse(this.response);A("#"+v+" #selected_file_"+l+" .du_progress").fadeOut("slow"),a.success?(A("#"+v).trigger("file_upload_end",[i.name]),A("#"+v+" #selected_file_"+l+" div.percent").fadeOut("slow"),i.type.match("image/*")||(i.type.match("video/*")?A("#"+v+" #selected_file_"+l+" div.thumbnail").append('<i class="pe-7s-video"></i>'):i.type.match("audio/*")?A("#"+v+" #selected_file_"+l+" div.thumbnail").append('<i class="pe-7s-volume"></i>'):A("#"+v+" #selected_file_"+l+" div.thumbnail").append('<i class="pe-7s-file"></i>'),A("#"+v+" #selected_file_"+l+" div.thumbnail i").hide().delay(500).fadeIn("slow")),t=A('<i class="pe-7s-trash action-delete" data-fileid="'+a.file_id+'"></i>').hide(),"thumbnails"==b?A("#"+v+" #selected_file_"+l+" div.thumbnail").append(t):"list"==b&&A("#"+v+" #selected_file_"+l).append(t),t.delay(500).fadeIn("slow"),A("#"+v).append('<input id="hidden_file_'+l+'" type="hidden" name="'+h+'" value="'+a.file_id+'" >'),A("#"+v+" #selected_file_"+l+" i.action-delete").on("click",function(e){var t=A(this).data("fileid");A.ajax({url:x,data:"fileid="+t}).done(function(){A("#"+v+" #selected_file_"+l).delay(500).fadeOut("slow"),A("#"+v+" #hidden_file_"+l).remove(),m--})}),g--):(S(a.message),A("#"+v+" #selected_file_"+l).delay(1e3*E.time_show_errors).fadeOut("slow"))}),e.open("post",w,!0),(t=new FormData).append(h.replace("[]",""),i),e.send(t))}function O(o,_){var l,n,d,p,u,c;function f(){var e,t,a,i=d+n;l-i<0&&(i=l),function(e,t,a,l,n){var i=new FormData,d=new XMLHttpRequest,s=A("#"+v+" #selected_file_"+_+" .du_progress"),r=A("#"+v+" #selected_file_"+_+" .percent");d.open("POST",w,!0),i.append("start",t),i.append("end",a),i.append(h.replace("[]",""),e),i.append("chunk",p),i.append("file_name",o.name),a<l?i.append("chunk_last",!1):i.append("chunk_last",!0);u=void 0!==c?c:0;c=a/l,(d.upload||d).addEventListener("progress",function(e){var t=e.position||e.loaded,a=e.totalSize||e.total,i=Math.round(t/a*100);l<n?(r.html(Math.round(i)+"%"),U(s[0],i/100,b)):(r.html(Math.round(100*(i/100*(c-u)+u))+"%"),U(s[0],i/100*(c-u)+u,b))}),d.onreadystatechange=function(){var e,t;d.readyState==XMLHttpRequest.DONE&&200==d.status&&(e=JSON.parse(this.response),a<l?f():e.success&&"file"==e.type&&(A("#"+v+" #selected_file_"+_+" .du_progress").fadeOut("slow"),A("#"+v).trigger("file_upload_end",[o.name]),A("#"+v+" #selected_file_"+_+" div.percent").fadeOut("slow"),o.type.match("image/*")||(o.type.match("video/*")?A("#"+v+" #selected_file_"+_+" div.thumbnail").append('<i class="pe-7s-video"></i>'):o.type.match("audio/*")?A("#"+v+" #selected_file_"+_+" div.thumbnail").append('<i class="pe-7s-volume"></i>'):A("#"+v+" #selected_file_"+_+" div.thumbnail").append('<i class="pe-7s-file"></i>'),A("#"+v+" #selected_file_"+_+" div.thumbnail i").hide().delay(500).fadeIn("slow")),t=A('<i class="pe-7s-trash action-delete" data-fileid="'+e.file_id+'"></i>').hide(),"thumbnails"==b?A("#"+v+" #selected_file_"+_+" div.thumbnail").append(t):"list"==b&&A("#"+v+" #selected_file_"+_).append(t),t.delay(500).fadeIn("slow"),A("#"+v).append('<input id="hidden_file_'+_+'" type="hidden" name="'+h+'" value="'+e.file_id+'" >'),A("#"+v+" #selected_file_"+_+" i.action-delete").on("click",function(e){var t=A(this).data("fileid");A.ajax({url:x,data:"fileid="+t}).done(function(){A("#"+v+" #selected_file_"+_).delay(500).fadeOut("slow"),A("#"+v+" #hidden_file_"+_).remove(),m--})}),g--))},d.send(i)}((t=d,a=i,((e=o).mozSlice?e.mozSlice:e.webkitSlice?e.webkitSlice:e.slice?e.slice:D).bind(e)(t,a)),d,i,l,n),p++,i<l&&(d+=n)}g>=E.concurrent_uploads?setTimeout(O,5e3,o,_):(g++,A("#"+v).trigger("file_upload_start",[o.name]),"thumbnails"==b?(A("#"+v+" #selected_file_"+_+" div.thumbnail").after('<div class="du_progress"></div>'),E.show_percentage&&A("#"+v+" #selected_file_"+_+" div.thumbnail").append('<div class="percent"></div>')):(A("#"+v+" #selected_file_"+_).append('<div class="du_progress"></div>'),E.show_percentage&&A("#"+v+" #selected_file_"+_).append('<div class="percent"></div>')),l=o.size,n=E.chunk_size,p=d=0,f(),u=0)}function D(){}function S(e){A("#"+v+" .errors").html("<p>"+e+"</p>"),0<E.time_show_errors&&setTimeout(z,1e3*E.time_show_errors)}function z(){A("#"+v+" .errors p").fadeOut("slow",function(){A("#"+v+" .errors p").remove()})}function C(e){var t=!0;if(_)if(p){if(e.length+m>p)return S(E.allowed_before_error_text+" "+p+" "+E.allowed_after_error_text),"normal"==c&&(m=0),!1;t=!0}else t=!0;else{if(1<e.length||0<m)return S(E.only_one_error_text),!1;t=!0}if(void 0===o)t=!0;else for(var a=o.split(","),i=0;i<e.length;i++){for(var l=0,n=0;n<a.length;n++){var d,s=a[n].replace("/",".").trim();""===e[i].type?(d=e[i].name.split(".").pop().toLowerCase(),-1<a[n].indexOf(d)&&l++):null!=e[i].type.match(s)&&l++}if(0==l)return S(E.not_allowed_error_text),!1}for(var r,i=0;i<e.length;i++)if(e[i].size>u&&0<u)return S(E.big_file_before_error_text+" "+(1e9<=(r=u)?r=(r/1e9).toFixed(2)+" GB":1e6<=r?r=(r/1e6).toFixed(2)+" MB":1e3<=r?r=(r/1e3).toFixed(2)+" KB":1<r?r+=" bytes":1==r?r+=" byte":r="0 byte",r)+" "+E.big_file_after_error_text),!1;return t}function F(e){A(e).css({display:"none"})}function T(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=0;a<15;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}function U(e,t,a){var i,l,n,d,s=e.children[0],r=(i=E.progress_color,/^#([A-Fa-f0-9]{3}){1,2}$/.test(i)?(3==(l=i.substring(1).split("")).length&&(l=[l[0],l[0],l[1],l[1],l[2],l[2]]),"rgba("+[(l="0x"+l.join(""))>>16&255,l>>8&255,255&l].join(",")+",.8)"):"rgba(74, 144, 226, .8)");void 0===s&&(s=document.createElement("canvas")),d="thumbnails"==a?(s.width=100,s.height=100,s.style.width="50px",s.style.height="50px",n=96,8):(s.width=48,s.height=48,s.style.width="24px",s.style.height="24px",n=48,4),e.appendChild(s),"undefined"!=typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(s);var o=s.getContext("2d");o.translate(n/2,n/2),o.rotate(-.5*Math.PI);var _=(n-d)/2;t=Math.min(Math.max(0,t||1),1),o.beginPath(),o.arc(0,0,_,0,2*Math.PI*t,!1),o.strokeStyle=r,o.lineCap="round",o.lineWidth=d,o.stroke()}j[0].ondragover=function(e){return j.addClass("hover"),"normal"==c?(a=A(t=d).parent(".drop_zone"),i=a.position(),l=i.top+parseInt(a.css("marginTop"),10),n=i.left+parseInt(a.css("marginLeft"),10),A(t).css({top:l,left:n,position:"absolute",width:a.width(),height:a.height(),display:"block"}),!1):"ajax"==c||"chunked"==c?(F(d),!1):void 0;var t,a,i,l,n},j[0].ondragleave=function(e){return j.removeClass("hover"),!1},j[0].ondrop=function(e){var t,a,i,l;F(d),z(),"normal"==c?0==C(l=e.dataTransfer.files)&&(A("#"+v+" .files").html(""),t=T(),a=A(d)[0].outerHTML,i=A.parseHTML(a),A(i).attr("id",t),A(d).before(i),A(d).remove(),d=A("#"+t)[0],A(d).change(function(){I()}),e.preventDefault?e.preventDefault():e.returnValue=!1):"ajax"!=c&&"chunked"!=c||(e.preventDefault?e.preventDefault():e.returnValue=!1,C(l=e.dataTransfer.files)&&I(l))},A(j).find("."+E.browse_css_selector).click(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,A(d).click()}),A(d).change(function(){var e,t,a,i=A(d)[0].files,l=C(i);"normal"==c?0==l?(A("#"+v+" .files").html(""),e=T(),t=A(d)[0].outerHTML,a=A.parseHTML(t),A(a).attr("id",e),A(d).before(a),A(d).remove(),d=A("#"+e)[0],A(d).change(function(){I()}),event.preventDefault?event.preventDefault():event.returnValue=!1):I(i):"ajax"!=c&&"chunked"!=c||l&&I(i)})})}}(jQuery);